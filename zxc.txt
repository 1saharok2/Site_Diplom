1. Изменяем структуру таблицы products
Меняем тип колонки image_url на массив:

sql
-- Если колонка уже существует как TEXT
ALTER TABLE products 
ALTER COLUMN image_url TYPE TEXT[] 
USING CASE 
  WHEN image_url IS NULL THEN '{}' 
  ELSE ARRAY[image_url] 
END;

-- Или добавляем значение по умолчанию
ALTER TABLE products 
ALTER COLUMN image_url SET DEFAULT '{}';
2. Обновляем сервис для работы с массивом в image_url
javascript
// services/adminService.js

// Получение товаров
const getProducts = async () => {
  const { data: products, error } = await supabase
    .from('products')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) throw error;
  
  // Преобразуем данные для удобства
  return products.map(product => ({
    ...product,
    // Обеспечиваем, что image_url всегда массив
    image_url: Array.isArray(product.image_url) ? product.image_url : 
              product.image_url ? [product.image_url] : [],
    mainImage: product.image_url && product.image_url.length > 0 ? product.image_url[0] : null
  }));
};

// Создание/обновление товара
const saveProduct = async (productData, isUpdate = false) => {
  const { data: product, error } = await supabase
    .from('products')
    .upsert({
      id: isUpdate ? productData.id : undefined,
      name: productData.name,
      price: productData.price,
      description: productData.description,
      category_slug: productData.category_slug,
      brand: productData.brand,
      stock: productData.stock,
      image_url: productData.image_url || [] // Сохраняем массив в image_url
    })
    .select()
    .single();

  if (error) throw error;
  return product;
};
3. Компонент карусели (адаптированный для image_url)
jsx
// components/ProductImageCarousel.jsx
import React, { useState } from 'react';
import {
  Box,
  IconButton,
  Chip,
  useTheme
} from '@mui/material';
import {
  NavigateBefore,
  NavigateNext
} from '@mui/icons-material';

const ProductImageCarousel = ({ image_url = [], height = 300 }) => {
  const [currentIndex, setCurrentIndex] = useState(0);
  const theme = useTheme();

  // Обеспечиваем, что image_url всегда массив
  const images = Array.isArray(image_url) ? image_url : 
                image_url ? [image_url] : [];

  if (images.length === 0) {
    return (
      <Box
        sx={{
          height,
          backgroundColor: theme.palette.grey[100],
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          borderRadius: 2,
          color: theme.palette.grey[500],
          fontSize: '0.9rem'
        }}
      >
        Нет изображения
      </Box>
    );
  }

  const nextImage = () => {
    setCurrentIndex((prevIndex) => 
      prevIndex === images.length - 1 ? 0 : prevIndex + 1
    );
  };

  const prevImage = () => {
    setCurrentIndex((prevIndex) => 
      prevIndex === 0 ? images.length - 1 : prevIndex - 1
    );
  };

  const goToImage = (index) => {
    setCurrentIndex(index);
  };

  return (
    <Box sx={{ 
      position: 'relative', 
      height, 
      overflow: 'hidden',
      borderRadius: 2,
      border: `1px solid ${theme.palette.grey[200]}`
    }}>
      {/* Главное изображение */}
      <Box
        component="img"
        src={images[currentIndex]}
        alt={`Product image ${currentIndex + 1}`}
        sx={{
          width: '100%',
          height: '100%',
          objectFit: 'cover',
          transition: 'transform 0.3s ease',
          '&:hover': {
            transform: 'scale(1.02)'
          }
        }}
        onError={(e) => {
          e.target.src = '/placeholder-product.jpg';
        }}
      />

      {/* Навигационные кнопки */}
      {images.length > 1 && (
        <>
          <IconButton
            onClick={prevImage}
            sx={{
              position: 'absolute',
              left: 8,
              top: '50%',
              transform: 'translateY(-50%)',
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              '&:hover': {
                backgroundColor: 'white'
              },
              boxShadow: theme.shadows[2]
            }}
          >
            <NavigateBefore />
          </IconButton>

          <IconButton
            onClick={nextImage}
            sx={{
              position: 'absolute',
              right: 8,
              top: '50%',
              transform: 'translateY(-50%)',
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              '&:hover': {
                backgroundColor: 'white'
              },
              boxShadow: theme.shadows[2]
            }}
          >
            <NavigateNext />
          </IconButton>
        </>
      )}

      {/* Индикатор текущего изображения */}
      {images.length > 1 && (
        <Box
          sx={{
            position: 'absolute',
            bottom: 16,
            left: '50%',
            transform: 'translateX(-50%)',
            display: 'flex',
            gap: 0.5,
            backgroundColor: 'rgba(0, 0, 0, 0.6)',
            padding: '6px 12px',
            borderRadius: 3
          }}
        >
          {images.map((_, index) => (
            <Box
              key={index}
              onClick={() => goToImage(index)}
              sx={{
                width: 6,
                height: 6,
                borderRadius: '50%',
                backgroundColor: currentIndex === index ? 'white' : 'rgba(255, 255, 255, 0.4)',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                '&:hover': {
                  backgroundColor: 'white',
                  transform: 'scale(1.2)'
                }
              }}
            />
          ))}
        </Box>
      )}

      {/* Счетчик изображений */}
      {images.length > 1 && (
        <Chip
          label={`${currentIndex + 1}/${images.length}`}
          size="small"
          sx={{
            position: 'absolute',
            top: 12,
            right: 12,
            backgroundColor: 'rgba(0, 0, 0, 0.7)',
            color: 'white',
            fontSize: '0.75rem',
            height: 24
          }}
        />
      )}
    </Box>
  );
};

export default ProductImageCarousel;
4. Использование в карточке товара
jsx
// В карточке товара
<ProductImageCarousel 
  image_url={product.image_url || []} 
  height={250}
/>
5. Обновляем диалог редактирования товара
jsx
// В диалоге добавления/редактирования товара
<Grid item xs={12}>
  <TextField
    fullWidth
    label="URL изображений товара"
    value={Array.isArray(formData.image_url) ? formData.image_url.join(', ') : formData.image_url || ''}
    onChange={(e) => {
      const inputValue = e.target.value;
      if (inputValue.trim() === '') {
        setFormData({ ...formData, image_url: [] });
      } else {
        const urls = inputValue.split(',')
          .map(url => url.trim())
          .filter(url => url);
        setFormData({ ...formData, image_url: urls });
      }
    }}
    helperText="Введите URL изображений через запятую. Первое изображение будет главным."
    multiline
    rows={3}
    placeholder="https://example.com/image1.jpg, https://example.com/image2.jpg"
    InputProps={{
      startAdornment: (
        <InputAdornment position="start">
          <Image />
        </InputAdornment>
      )
    }}
  />
</Grid>

{formData.image_url && formData.image_url.length > 0 && (
  <Grid item xs={12}>
    <Typography variant="body2" gutterBottom color="text.secondary">
      Предпросмотр ({formData.image_url.length} изображений):
    </Typography>
    <Box sx={{ 
      display: 'flex', 
      gap: 1, 
      flexWrap: 'wrap',
      p: 2,
      backgroundColor: theme.palette.grey[50],
      borderRadius: 2,
      border: `1px solid ${theme.palette.grey[200]}`
    }}>
      {formData.image_url.map((url, index) => (
        <Box
          key={index}
          sx={{ 
            position: 'relative',
            border: index === 0 ? '2px solid' : '1px solid',
            borderColor: index === 0 ? theme.palette.primary.main : theme.palette.grey[300],
            borderRadius: 1,
            overflow: 'hidden',
            transition: 'transform 0.2s ease',
            '&:hover': {
              transform: 'scale(1.05)'
            }
          }}
        >
          <Box
            component="img"
            src={url}
            alt={`Preview ${index + 1}`}
            sx={{
              width: 60,
              height: 60,
              objectFit: 'cover'
            }}
            onError={(e) => {
              e.target.src = '/placeholder-product.jpg';
            }}
          />
          {index === 0 && (
            <Box
              sx={{
                position: 'absolute',
                top: 2,
                left: 2,
                backgroundColor: theme.palette.primary.main,
                color: 'white',
                fontSize: '0.6rem',
                padding: '1px 4px',
                borderRadius: 1,
                fontWeight: 'bold'
              }}
            >
              Главная
            </Box>
          )}
        </Box>
      ))}
    </Box>
  </Grid>
)}
6. Обработка старых данных
Для совместимости со старыми данными, где image_url мог быть строкой:

javascript
// В сервисе добавляем функцию для миграции старых данных
const migrateOldImageData = async () => {
  // Получаем товары где image_url - строка
  const { data: products, error } = await supabase
    .from('products')
    .select('id, image_url')
    .neq('image_url', '{}')
    .not('image_url', 'is', null);

  if (error) throw error;

  // Обновляем каждый товар
  for (const product of products) {
    if (typeof product.image_url === 'string') {
      await supabase
        .from('products')
        .update({ 
          image_url: [product.image_url] // Преобразуем в массив
        })
        .eq('id', product.id);
    }
  }
};
7. Пример данных в таблице
sql
-- Обновление существующих товаров
UPDATE products 
SET image_url = ARRAY['https://example.com/image1.jpg']
WHERE image_url IS NOT NULL AND typeof(image_url) = 'text';

-- Добавление нескольких изображений
UPDATE products 
SET image_url = ARRAY[
  'https://example.com/image1.jpg',
  'https://example.com/image2.jpg', 
  'https://example.com/image3.jpg'
]
WHERE id = 1;